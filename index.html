<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mersin Kadastro Müdürlüğü - Birim Yönetim Portalı</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.75); }
        .modal-content { max-height: 95vh; }
        .table-header-sticky th { position: sticky; top: 0; background-color: #1e3a8a; color: white; z-index: 10; }
        .fark-pozitif { background-color: #dcfce7; color: #166534; font-weight: bold; }
        .fark-negatif { background-color: #fee2e2; color: #991b1b; font-weight: bold; }
        .fark-sifir { background-color: #f1f5f9; color: #475569; }
        .nav-active { border-bottom-color: #fbbf24; color: #fbbf24; }
        .group-header { border-bottom: 3px solid #002d72; padding-bottom: 0.5rem; margin-bottom: 1.5rem; color: #002d72; }
        .readonly-cell { background-color: #f8fafc; color: #64748b; font-weight: 500; text-align: center; padding: 0.5rem; }
        .upload-card { display: flex; align-items: center; justify-content: center; border: 2px dashed #cbd5e1; border-radius: 0.5rem; min-height: 12rem; cursor: pointer; transition: all 0.2s ease-in-out; position: relative; }
        .upload-card:hover { border-color: #3b82f6; background-color: #eff6ff; }
        .gallery-item { position: relative; cursor: pointer; }
        .delete-btn { position: absolute; top: 0.5rem; right: 0.5rem; background-color: rgba(0, 0, 0, 0.6); color: white; border-radius: 50%; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: opacity 0.2s; z-index: 5; }
        .gallery-item:hover .delete-btn { opacity: 1; }
        .progress-bar-container { height: 8px; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; width: 100%; }
        .progress-bar { height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out; }
        .pdf-thumbnail { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 12rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; text-align: center; background-color: #f9fafb; }
        .pdf-thumbnail i { font-size: 3rem; color: #be123c; }
        .pdf-thumbnail span { margin-top: 1rem; font-size: 0.875rem; font-weight: 500; color: #4b5563; word-break: break-all; }
        #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 1rem; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        #lightbox.show { opacity: 1; visibility: visible; }
        #lightbox-content-wrapper { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #lightbox-content { max-width: 100%; max-height: 100%; display: block; transition: transform 0.2s ease; cursor: grab; }
        #lightbox-content.panning { cursor: grabbing; }
        #lightbox-content-wrapper iframe { width: 100%; height: 100%; background: white; border: none; border-radius: 0.5rem; }
        .lightbox-control { position: absolute; z-index: 1001; background-color: rgba(30, 41, 59, 0.7); color: white; border: none; border-radius: 50%; width: 3rem; height: 3rem; font-size: 1.25rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        .lightbox-control:hover { background-color: rgba(30, 41, 59, 1); }
        #lightbox-close { top: 1rem; right: 1rem; }
        #lightbox-zoom-controls { position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%); z-index: 1001; display: flex; gap: 0.5rem; background-color: rgba(30, 41, 59, 0.7); padding: 0.5rem; border-radius: 9999px; }
        #lightbox-zoom-controls button { background: none; border: none; color: white; width: 2.5rem; height: 2.5rem; font-size: 1.2rem; cursor: pointer; }
        .personnel-list-input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: #f9fafb; }
        .personnel-list-input:focus { outline: 2px solid #3b82f6; border-color: transparent; }
        .action-btn { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 0.375rem; transition: background-color 0.2s; margin: 0 0.25rem; }
        .edit-btn { color: #3b82f6; } .edit-btn:hover { background-color: #eff6ff; }
        .delete-btn-action { color: #ef4444; } .delete-btn-action:hover { background-color: #fee2e2; }
        .save-btn { color: #22c55e; } .save-btn:hover { background-color: #dcfce7; }
        .cancel-btn { color: #6b7280; } .cancel-btn:hover { background-color: #f3f4f6; }
        .confirm-delete { color: white !important; background-color: #ef4444 !important; }
        .scrollable-tabs::-webkit-scrollbar { display: none; }
        .scrollable-tabs { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16 md:h-20">
                <div class="flex items-center">
                    <img src="https://placehold.co/100x40/002d72/ffffff?text=TKGM" alt="TKGM Logo" class="h-8 md:h-10">
                    <div class="ml-3 md:ml-4">
                        <h1 class="text-lg md:text-xl font-bold text-gray-900">Birim Yönetim Portalı</h1>
                        <p class="text-xs md:text-sm text-gray-500">Mersin Kadastro Müdürlüğü</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 md:space-x-4">
                    <span class="hidden lg:block text-sm md:text-md font-medium text-gray-600">© Gökhan ELGÜL tarafından tasarlanmıştır.</span>
                      <i class="fa-solid fa-star text-yellow-400"></i>
                      <i class="fa-solid fa-star text-blue-800"></i>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 lg:p-8">
        <div id="dashboard-container" class="mb-10">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
                <h2 class="text-2xl md:text-3xl font-bold group-header flex-shrink-0" style="margin-bottom: 0;">Genel Durum Panosu</h2>
                <div id="summary-dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4 w-full"></div>
            </div>
        </div>
        <div id="kadastro-section" class="mb-10">
            <h2 class="text-xl md:text-2xl font-bold group-header">Mersin Kadastro Müdürlüğü</h2>
            <div id="kadastro-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6"></div>
        </div>
        <div id="ilce-section" class="mb-10">
            <h2 class="text-xl md:text-2xl font-bold group-header">Bağlı Birimler</h2>
            <div id="ilce-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6"></div>
        </div>
    </main>
    
    <div id="detail-modal" class="fixed inset-0 z-50 flex items-center justify-center p-0 sm:p-4 hidden modal-backdrop">
        <div id="modal-content" class="bg-white shadow-2xl w-full h-full sm:h-auto sm:w-full max-w-7xl flex flex-col modal-content sm:rounded-lg">
            <div class="flex items-center justify-between p-4 md:p-5 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                <h3 id="modal-title" class="text-xl md:text-2xl font-bold text-gray-900"></h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="flex-grow p-4 md:p-6 overflow-y-auto">
                <div class="border-b border-gray-200 mb-6">
                    <nav id="modal-tabs" class="scrollable-tabs -mb-px flex space-x-4 sm:space-x-8 overflow-x-auto" aria-label="Tabs">
                        <button data-tab="personnel" class="whitespace-nowrap py-3 px-2 md:py-4 md:px-1 border-b-4 font-medium text-sm md:text-lg"><i class="fas fa-users mr-2"></i>Personel Durumu</button>
                        <button data-tab="personnel-list" class="whitespace-nowrap py-3 px-2 md:py-4 md:px-1 border-b-4 font-medium text-sm md:text-lg"><i class="fas fa-address-book mr-2"></i>Personel Listesi</button>
                        <button data-tab="projects" class="whitespace-nowrap py-3 px-2 md:py-4 md:px-1 border-b-4 font-medium text-sm md:text-lg"><i class="fas fa-drafting-compass mr-2"></i>Mimari Projeler</button>
                        <button data-tab="photos" class="whitespace-nowrap py-3 px-2 md:py-4 md:px-1 border-b-4 font-medium text-sm md:text-lg"><i class="fas fa-camera-retro mr-2"></i>Oda Resimleri</button>
                    </nav>
                </div>
                <div id="tab-content">
                    <div id="personnel-content" class="tab-pane">
                        <div class="flex justify-end mb-4">
                            <button id="export-excel-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm"><i class="fas fa-file-excel mr-2"></i>Excel'e Aktar</button>
                        </div>
                        <div class="overflow-x-auto rounded-lg border">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="table-header-sticky">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Unvan</th>
                                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider">Norm</th>
                                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider">Mevcut</th>
                                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider">Fark</th>
                                    </tr>
                                </thead>
                                <tbody id="personnel-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="personnel-list-content" class="tab-pane hidden">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                            <div class="relative w-full sm:w-auto flex-grow">
                                <input type="text" id="personnel-search-input" placeholder="Personel ara..." class="w-full pl-10 pr-4 py-2 border rounded-full">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div>
                            </div>
                            <div class="flex items-center gap-2 w-full sm:w-auto justify-end">
                                <button id="export-personnel-list-excel-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm"><i class="fas fa-file-export mr-2"></i>Listeyi Dışa Aktar</button>
                            </div>
                        </div>
                        <div class="overflow-auto rounded-lg border" style="max-height: 55vh;">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="table-header-sticky">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Adı Soyadı</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Unvanı</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Sicil</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Görevli Olduğu Birim</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">IP Telefon</th>
                                    </tr>
                                </thead>
                                <tbody id="personnel-list-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="projects-content" class="tab-pane hidden">
                        <div id="projects-gallery" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                    <div id="photos-content" class="tab-pane hidden">
                        <div id="photos-gallery" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="all-personnel-modal" class="fixed inset-0 z-50 flex items-center justify-center p-0 sm:p-4 hidden modal-backdrop">
        <div class="bg-white rounded-none sm:rounded-lg shadow-2xl w-full h-full sm:h-auto max-w-7xl flex flex-col modal-content">
            <div id="all-personnel-modal-header" class="flex items-center justify-between p-4 md:p-5 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                <h3 id="all-personnel-modal-title" class="text-xl md:text-2xl font-bold text-gray-900 flex items-center gap-3"><i class="fas fa-users-cog text-blue-800"></i> Merkezi Yönetim</h3>
                <button id="close-all-personnel-modal-btn" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="flex-grow p-4 md:p-6 overflow-y-auto">
                <div class="border-b border-gray-200 mb-6">
                    <nav id="central-modal-tabs" class="scrollable-tabs -mb-px flex space-x-4 sm:space-x-8 overflow-x-auto" aria-label="Tabs">
                        <button data-tab="central-personnel-list" class="whitespace-nowrap py-3 px-2 md:py-4 md:px-1 border-b-4 font-medium text-sm md:text-lg">
                            <i class="fas fa-users mr-2"></i>Personel Listesi
                        </button>
                        <button data-tab="central-norm-management" class="whitespace-nowrap py-3 px-2 md:py-4 md:px-1 border-b-4 font-medium text-sm md:text-lg">
                            <i class="fas fa-sitemap mr-2"></i>Toplu Norm Yönetimi
                        </button>
                    </nav>
                </div>
                
                <div id="central-tab-content">
                    <div id="central-personnel-list-content" class="central-tab-pane">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <div class="relative w-full md:w-auto flex-grow">
                                <input type="text" id="all-personnel-search-input" placeholder="Personel veya Birim Ara..." class="w-full pl-10 pr-4 py-2 border rounded-full">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div>
                            </div>
                            <div class="flex items-center gap-2 flex-wrap justify-center md:justify-end w-full md:w-auto">
                                <button id="bulk-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed text-sm"><i class="fas fa-trash-alt mr-1"></i>Sil (<span id="bulk-delete-count">0</span>)</button>
                                <input type="file" id="import-all-personnel-excel-input" class="hidden" accept=".xlsx, .xls">
                                <button id="import-all-personnel-excel-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-3 rounded-lg text-sm"><i class="fas fa-file-import mr-1"></i>Yükle/Güncelle</button>
                                <button id="export-all-personnel-excel-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-sm"><i class="fas fa-file-export mr-1"></i>Aktar</button>
                            </div>
                        </div>
                        <div class="overflow-auto rounded-lg border" style="max-height: 60vh;">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="table-header-sticky">
                                    <tr>
                                        <th scope="col" class="px-2 py-3 sm:px-4"><input type="checkbox" id="select-all-personnel-checkbox"></th>
                                        <th scope="col" class="px-2 py-3 sm:px-6 text-left text-xs font-medium uppercase tracking-wider">Adı Soyadı</th>
                                        <th scope="col" class="px-2 py-3 sm:px-6 text-left text-xs font-medium uppercase tracking-wider">Unvanı</th>
                                        <th scope="col" class="px-2 py-3 sm:px-6 text-left text-xs font-medium uppercase tracking-wider">Sicil</th>
                                        <th scope="col" class="px-2 py-3 sm:px-6 text-left text-xs font-medium uppercase tracking-wider">Birim</th>
                                        <th scope="col" class="px-2 py-3 sm:px-6 text-left text-xs font-medium uppercase tracking-wider">Görevli Olduğu Birim</th>
                                        <th scope="col" class="px-2 py-3 sm:px-6 text-left text-xs font-medium uppercase tracking-wider">IP Telefon</th>
                                        <th scope="col" class="px-2 py-3 sm:px-6 text-center text-xs font-medium uppercase tracking-wider w-28">İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="all-personnel-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="add-all-personnel-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm"><i class="fas fa-plus mr-2"></i>Yeni Personel Ekle</button>
                        </div>
                    </div>

                    <div id="central-norm-management-content" class="central-tab-pane hidden">
                         <div class="space-y-6">
                             <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                 <p class="font-semibold text-blue-800"><i class="fas fa-info-circle mr-2"></i>Nasıl Çalışır?</p>
                                 <p class="text-sm text-blue-700 mt-1">
                                     Şablonu indirin. Şablonda mevcut durum referans olarak yer alır. Güncelleme yapmak için **'Norm_Sayisi' ve 'Mevcut_Sayisi' sütunlarını** değiştirip dosyayı kaydedin ve 'Excel Yükle' butonu ile sisteme yükleyin.
                                 </p>
                             </div>
                            
                             <div class="border rounded-lg p-4">
                                 <h4 class="font-semibold text-lg text-gray-700 mb-3">Mersin Kadastro Müdürlüğü Norm</h4>
                                 <div class="flex flex-col sm:flex-row gap-4">
                                     <button data-group="kadastro" class="norm-template-btn w-full sm:w-1/2 flex items-center justify-center gap-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg"><i class="fas fa-download"></i><span>Şablonu İndir</span></button>
                                     <button data-group="kadastro" class="norm-upload-btn w-full sm:w-1/2 flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg"><i class="fas fa-upload"></i><span>Excel Yükle</span></button>
                                 </div>
                             </div>
                             <input type="file" id="norm-excel-input" class="hidden" accept=".xlsx, .xls">
                             <div id="norm-upload-report" class="hidden p-4 bg-gray-100 rounded-lg text-sm"></div>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="lightbox"><div id="lightbox-content-wrapper"></div><button id="lightbox-close" class="lightbox-control"><i class="fas fa-times"></i></button><div id="lightbox-zoom-controls"><button id="zoom-in" class="lightbox-control" style="position: static;"><i class="fas fa-plus"></i></button><button id="zoom-out" class="lightbox-control" style="position: static;"><i class="fas fa-minus"></i></button></div></div>

    <script>
        // --- Global Değişkenler ve Veri Paketi ---
        let directorateData = [];
        let currentDirectorateId = null;
        let currentZoom = 1, isPanning = false, startX, startY, translateX, translateY;
        const GITHUB_REPO_BASE_URL = 'https://gokhangeo.github.io/mersin-norm/';
        const SUB_UNITS = ['ANAMUR', 'ERDEMLİ', 'MUT', 'SİLİFKE', 'TARSUS'];

        // Başlangıç veri yapısı
        const initialData = [
            { id: 'mersin_km', name: 'MERSİN KADASTRO MÜDÜRLÜĞÜ', group: 'kadastro', personnel: [], personnelList: [], projects: [], photos: [] },
            ...SUB_UNITS.map(unit => ({
                id: `${unit.toLocaleLowerCase('tr-TR')}_kb`,
                name: `${unit} KADASTRO BİRİMİ`,
                group: 'ilce',
                personnel: [], // Normları yok
                personnelList: [],
                projects: [],
                photos: []
            }))
        ];
        
        // --- DOM Elements ---
        const modal = document.getElementById('detail-modal');
        const modalTitle = document.getElementById('modal-title');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const personnelTableBody = document.getElementById('personnel-table-body');
        const projectsGallery = document.getElementById('projects-gallery');
        const photosGallery = document.getElementById('photos-gallery');
        const modalTabs = document.getElementById('modal-tabs');
        const tabPanes = document.querySelectorAll('.tab-pane');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const personnelListTableBody = document.getElementById('personnel-list-table-body');
        const personnelSearchInput = document.getElementById('personnel-search-input');
        const exportPersonnelListExcelBtn = document.getElementById('export-personnel-list-excel-btn');
        const lightbox = document.getElementById('lightbox');
        const lightboxContentWrapper = document.getElementById('lightbox-content-wrapper');
        const lightboxCloseBtn = document.getElementById('lightbox-close');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const zoomControls = document.getElementById('lightbox-zoom-controls');
        const allPersonnelModal = document.getElementById('all-personnel-modal');
        const closeAllPersonnelModalBtn = document.getElementById('close-all-personnel-modal-btn');
        const allPersonnelTableBody = document.getElementById('all-personnel-table-body');
        const allPersonnelSearchInput = document.getElementById('all-personnel-search-input');
        const addAllPersonnelBtn = document.getElementById('add-all-personnel-btn');
        const exportAllPersonnelExcelBtn = document.getElementById('export-all-personnel-excel-btn');
        const importAllPersonnelExcelBtn = document.getElementById('import-all-personnel-excel-btn');
        const importAllPersonnelExcelInput = document.getElementById('import-all-personnel-excel-input');
        const centralModalTabs = document.getElementById('central-modal-tabs');
        const centralTabPanes = document.querySelectorAll('.central-tab-pane');
        const normTemplateButtons = document.querySelectorAll('.norm-template-btn');
        const normUploadButtons = document.querySelectorAll('.norm-upload-btn');
        const normExcelInput = document.getElementById('norm-excel-input');
        const normUploadReport = document.getElementById('norm-upload-report');
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
        const bulkDeleteCount = document.getElementById('bulk-delete-count');
        const selectAllPersonnelCheckbox = document.getElementById('select-all-personnel-checkbox');

        // --- Veri Yönetimi ve Yardımcı Fonksiyonlar ---
        function normalizeString(str) { if (typeof str !== 'string') return ''; return str.trim().replace(/\s+/g, ' ').toLocaleLowerCase('tr-TR'); }
        function getValueFromRow(row, possibleKeys) { const normalizedRowKeys = Object.keys(row).map(key => ({ original: key, normalized: normalizeString(key) })); for (const possibleKey of possibleKeys) { const normalizedPossibleKey = normalizeString(possibleKey); const foundKey = normalizedRowKeys.find(rk => rk.normalized === normalizedPossibleKey); if (foundKey) { return row[foundKey.original]; } } return undefined; }
        function saveData() { try { localStorage.setItem('mersinPortalData', JSON.stringify(directorateData)); } catch (e) { console.error("Veri kaydedilirken hata oluştu:", e); alert("Veriler kaydedilemedi. Tarayıcı depolama alanı dolu olabilir."); } }
        
        function loadData() {
            const savedData = localStorage.getItem('mersinPortalData');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    if (Array.isArray(parsedData) && parsedData.length > 0 && parsedData.every(item => 'id' in item && 'name' in item)) {
                        directorateData = parsedData;
                        return true;
                    } else { throw new Error("Invalid data structure"); }
                } catch (e) {
                    console.error("Kaydedilmiş veri okunurken hata, başlangıç verileri kullanılıyor:", e);
                    directorateData = JSON.parse(JSON.stringify(initialData));
                }
            } else {
                directorateData = JSON.parse(JSON.stringify(initialData));
            }
            directorateData.forEach(d => {
                if (!d.personnelList) d.personnelList = [];
                if (!d.projects) d.projects = [];
                if (!d.photos) d.photos = [];
            });
            return false;
        }

        async function initializeApp() {
            try {
                await loadInitialSetup();
            } catch (error) {
                console.warn("GitHub'dan veri çekilemedi. Yerel depolamadan yükleme deneniyor.", error);
                const hasSavedData = loadData();
                if (!hasSavedData) {
                    console.error("Hem GitHub hem de yerel depolamadan veri yüklenemedi. Başlangıç verileri kullanılıyor.");
                }
            }
            refreshAllViews();
        }

        async function loadInitialSetup() {
            console.log("GitHub üzerinden başlangıç şablonları yükleniyor...");
            const templatePaths = [
                { path: 'NORM.xlsx', type: 'norm' },
                { path: 'PERSONEL.xlsx', type: 'personnel' }
            ];

            const processFile = async (fileInfo) => {
                const fullPath = GITHUB_REPO_BASE_URL + fileInfo.path + `?v=${new Date().getTime()}`;
                const response = await fetch(fullPath);
                if (!response.ok) throw new Error(`Dosya bulunamadı: ${response.statusText} (${fullPath})`);
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                return { type: fileInfo.type, data: jsonData };
            };

            const results = await Promise.all(templatePaths.map(processFile));
            
            const normData = results.find(r => r && r.type === 'norm')?.data;
            const personnelData = results.find(r => r && r.type === 'personnel')?.data;
            
            directorateData = JSON.parse(JSON.stringify(initialData));

            if (!normData || !personnelData) {
                throw new Error("Gerekli NORM veya PERSONEL dosyaları GitHub'dan yüklenemedi.");
            }
            
            updateNormsFromData(normData);
            console.log("Norm verileri şablondan başarıyla yüklendi.");
            
            updatePersonnelFromData(personnelData);
            console.log("Personel listesi şablondan başarıyla yüklendi.");
            
            saveData();
            console.log("En güncel veriler yerel depolamaya kaydedildi.");
        }


        function updateNormsFromData(data) {
            let updatedCount = 0;
            const mersinKM = directorateData.find(d => d.id === 'mersin_km');
            if (!mersinKM) return;
            
            mersinKM.personnel = [];

            data.forEach(row => {
                const unvanRaw = getValueFromRow(row, ['Unvan', 'Unvanı']);
                const normSayisi = parseInt(getValueFromRow(row, ['Norm_Sayisi', 'Norm Sayısı', 'Norm']), 10);
                
                if (!unvanRaw || isNaN(normSayisi)) return;

                mersinKM.personnel.push({
                    title: String(unvanRaw).trim(),
                    norm: normSayisi,
                    current: 0
                });
                updatedCount++;
            });
            console.log(`${updatedCount} adet norm kadro satırı Excel verisinden yüklendi.`);
        }

        function updatePersonnelFromData(data) {
            directorateData.forEach(dir => dir.personnelList = []);

            let addedCount = 0;
            data.forEach(row => {
                const name = getValueFromRow(row, ['Adı Soyadı', 'Adi Soyadi', 'Ad Soyad']);
                const title = getValueFromRow(row, ['Unvanı', 'Unvani', 'Unvan']);
                const sicil = getValueFromRow(row, ['Sicil', 'Sicil No']);
                const görevliBirimRaw = getValueFromRow(row, ['Görevli Olduğu Birim', 'Gorevli Oldugu Birim']);
                const ipTelefon = getValueFromRow(row, ['İp Telefon', 'Ip Telefon', 'Telefon']);

                if (!sicil || !name || !title) return;

                const newPersonData = { 
                    name: String(name).trim(), 
                    title: String(title).trim(), 
                    sicil: String(sicil).trim(),
                    görevliBirim: görevliBirimRaw ? String(görevliBirimRaw).trim() : 'Mersin',
                    ipTelefon: ipTelefon ? String(ipTelefon).trim() : ''
                };
                
                let targetDir = null;
                const normalizedGörevliBirim = normalizeString(newPersonData.görevliBirim);

                if (normalizeString(newPersonData.görevliBirim) === 'geçici görevli') {
                    targetDir = directorateData.find(d => d.id === 'mersin_km');
                    newPersonData.name += ' (Geçici Görevli)';
                } else {
                    const subUnitId = `${normalizedGörevliBirim}_kb`;
                    targetDir = directorateData.find(d => d.id === subUnitId);
                }

                if (!targetDir) {
                    targetDir = directorateData.find(d => d.id === 'mersin_km');
                }

                if (targetDir) {
                    targetDir.personnelList.push(newPersonData);
                    addedCount++;
                }
            });
            
            recalculateCurrentPersonnelCounts();
            console.log(`${addedCount} adet personel Excel verisinden eklendi.`);
        }
        
        function recalculateCurrentPersonnelCounts() {
            const mersinKM = directorateData.find(d => d.id === 'mersin_km');
            if (!mersinKM) return;

            mersinKM.personnel.forEach(p => p.current = 0);

            const allPersonnel = getAggregatedPersonnel();

            const incrementNormCurrent = (normTitle) => {
                const normEntry = mersinKM.personnel.find(p => normalizeString(p.title) === normalizeString(normTitle));
                if (normEntry) {
                    normEntry.current++;
                } else {
                    console.warn(`Norm kadro başlığı bulunamadı: "${normTitle}"`);
                }
            };

            allPersonnel.forEach(person => {
                const personTitle = normalizeString(person.title);

                if (personTitle.includes('güvenlik')) {
                    incrementNormCurrent('Güvenlik Personeli');
                } else if (personTitle.includes('mühendis')) {
                    incrementNormCurrent('Mühendis');
                } else if (personTitle.includes('tekniker') || personTitle.includes('teknisyen') || personTitle.includes('kontrol memuru')) {
                    incrementNormCurrent('Teknisyen/Tekniker');
                } else if (personTitle.includes('bilgisayar işletmeni') || personTitle.includes('memur')) { // GÜNCELLEME: 'memur' eklendi
                    incrementNormCurrent('İşlem Yapan Personel');
                } else if (personTitle.includes('işçi')) {
                    incrementNormCurrent('Destek Personeli');
                } else {
                    const directMatch = mersinKM.personnel.find(p => normalizeString(p.title) === personTitle);
                    if (directMatch) {
                        directMatch.current++;
                    } else {
                        console.warn(`"${person.title}" unvanı için doğrudan bir norm kadro eşleşmesi bulunamadı.`);
                    }
                }
            });
        }
        
        // --- UI Fonksiyonları ---
        function getAggregatedPersonnel() { let allPersonnel = []; directorateData.forEach(dir => { if (dir.personnelList && Array.isArray(dir.personnelList)) { dir.personnelList.forEach((p, index) => { allPersonnel.push({ ...p, directorateName: dir.name, directorateId: dir.id, originalIndex: index }); }); } }); return allPersonnel; }
        
        function createGrandTotalCard(stats) { const { norm, current, unitCount } = stats; const difference = current - norm; const occupancyRate = norm > 0 ? Math.round((current / norm) * 100) : (current > 0 ? 100 : 0); let progressBarColor = 'bg-red-500'; if (occupancyRate >= 100) progressBarColor = 'bg-green-500'; else if (occupancyRate >= 90) progressBarColor = 'bg-yellow-400'; let diffClass = 'text-slate-700'; let diffBgClass = 'bg-slate-200'; if (difference > 0) { diffClass = 'text-green-800'; diffBgClass = 'bg-green-100'; } else if (difference < 0) { diffClass = 'text-red-800'; diffBgClass = 'bg-red-100'; } const card = document.createElement('div'); card.className = 'xl:col-span-3 bg-blue-50 rounded-lg shadow-lg p-4 flex flex-col justify-between border-l-8 border-blue-700'; card.innerHTML = `<div><div class="flex justify-between items-start"><div><p class="text-base font-bold text-blue-800">MERSİN KADASTRO MÜDÜRLÜĞÜ</p><p class="text-xs text-gray-500">${unitCount} Birim Dahil</p></div><div class="w-12 h-12 flex items-center justify-center rounded-full bg-blue-600 text-white shadow-md"><i class="fas fa-bullseye fa-lg"></i></div></div><div class="mt-4"><div class="flex justify-between items-center mb-1"><span class="text-sm font-semibold text-gray-600">Genel Doluluk Oranı</span><span class="text-xl font-bold text-blue-800">${occupancyRate}%</span></div><div class="progress-bar-container bg-blue-100"><div class="progress-bar ${progressBarColor}" style="width: ${occupancyRate > 100 ? 100 : occupancyRate}%;"></div></div></div></div><div class="mt-4 pt-4 border-t-2 border-blue-200 flex justify-between items-center text-base"><div><span class="text-gray-600">Norm:</span> <b class="text-gray-900 text-2xl">${norm}</b></div><div><span class="text-gray-600">Mevcut:</span> <b class="text-gray-900 text-2xl">${current}</b></div><div class="px-3 py-1 rounded-full ${diffBgClass} ${diffClass}"><b class="text-lg">${difference >= 0 ? '+' : ''}${difference}</b></div></div>`; return card; }
        
        function createPersonnelManagementCard(stats) { const { totalInLists } = stats; const card = document.createElement('div'); card.className = `xl:col-span-2 bg-white rounded-lg shadow p-4 flex flex-col justify-between cursor-pointer hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-1`; card.innerHTML = `<div><div class="flex justify-between items-start"><div><p class="text-sm font-semibold text-gray-500">Merkezi Yönetim</p><p class="text-xs text-gray-400">Personel & Norm</p></div><div class="w-10 h-10 flex items-center justify-center rounded-full bg-blue-100 text-blue-600"><i class="fas fa-users-cog"></i></div></div><div class="mt-4 text-center"><p class="text-3xl font-bold text-gray-800">${totalInLists}</p><p class="text-sm text-gray-500">Kayıtlı Personel</p></div></div><div class="mt-3 pt-3 border-t border-gray-100 text-center"><span class="text-sm font-medium text-blue-600 hover:text-blue-800">Yönetim Panelini Aç <i class="fas fa-arrow-right ml-1"></i></span></div>`; card.addEventListener('click', () => { switchCentralTab('central-personnel-list'); populateAllPersonnelTable(); allPersonnelModal.classList.remove('hidden'); document.body.style.overflow = 'hidden'; }); return card; }
        
        function renderSummaryDashboard() { if (!directorateData || directorateData.length === 0) return; const summaryContainer = document.getElementById('summary-dashboard'); summaryContainer.innerHTML = ''; const mersinKM = directorateData.find(d => d.id === 'mersin_km'); if (!mersinKM) return; const grandTotalNorm = mersinKM.personnel.reduce((s, p) => s + (p.norm || 0), 0); const grandTotalCurrent = getAggregatedPersonnel().length; summaryContainer.appendChild(createGrandTotalCard({ norm: grandTotalNorm, current: grandTotalCurrent, unitCount: directorateData.length })); const totalInLists = getAggregatedPersonnel().length; summaryContainer.appendChild(createPersonnelManagementCard({ totalInLists })); }
        
        function renderAllCards(){if(!directorateData||directorateData.length===0)return;document.querySelectorAll('[id$="-grid"]').forEach(grid=>grid.innerHTML='');directorateData.forEach(dir=>{const grid=document.getElementById(`${dir.group}-grid`);if(!grid)return;let card;if(dir.group==='kadastro'){const totalNorm=dir.personnel.reduce((sum,p)=>sum+(p.norm||0),0);const totalCurrent=dir.personnel.reduce((sum,p)=>sum+(p.current||0),0); const difference=totalCurrent-totalNorm;const occupancyRate=totalNorm>0?Math.round((totalCurrent/totalNorm)*100):(totalCurrent>0?100:0);let progressBarColor='bg-red-500';if(occupancyRate>=90)progressBarColor='bg-green-500';else if(occupancyRate>=70)progressBarColor='bg-yellow-400';let diffClass='fark-sifir';let diffIcon='fa-minus';if(difference>0){diffClass='bg-green-200 text-green-800';diffIcon='fa-arrow-up'}else if(difference<0){diffClass='bg-red-200 text-red-800';diffIcon='fa-arrow-down'}
        card=document.createElement('div');card.className='bg-white rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300 cursor-pointer overflow-hidden transform hover:-translate-y-1';card.dataset.id=dir.id;card.innerHTML=`<div class="p-5"><div class="flex justify-between items-start"><h3 class="text-lg font-bold text-gray-900 truncate pr-2">${dir.name}</h3><span class="text-xs font-bold px-2 py-1 rounded-full ${diffClass}"><i class="fas ${diffIcon} mr-1"></i> ${difference>=0?'+':''}${difference}</span></div><div class="mt-4"><div class="flex justify-between items-center mb-1"><span class="text-xs font-semibold text-gray-500">Doluluk Oranı</span><span class="text-sm font-bold ${progressBarColor.replace('bg','text')}">${occupancyRate}%</span></div><div class="progress-bar-container"><div class="progress-bar ${progressBarColor}" style="width: ${occupancyRate}%;"></div></div></div></div><div class="px-5 pb-5 flex justify-between items-center text-sm text-gray-600"><span>Norm: <b class="text-gray-900">${totalNorm}</b></span><span>Mevcut: <b class="text-gray-900">${totalCurrent}</b></span></div><div class="bg-gray-50 px-5 py-3 text-right"><span class="text-sm font-medium text-blue-600 hover:text-blue-800">Detayları Gör <i class="fas fa-arrow-right ml-1"></i></span></div>`;}else if(dir.group==='ilce'){const totalCurrent=dir.personnelList.length;card=document.createElement('div');card.className='bg-white rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300 cursor-pointer overflow-hidden transform hover:-translate-y-1';card.dataset.id=dir.id;card.innerHTML=`<div class="p-5"><h3 class="text-lg font-bold text-gray-900 truncate pr-2">${dir.name}</h3><div class="mt-4 flex items-center justify-center gap-4"><i class="fas fa-users text-3xl text-blue-500"></i><div><p class="text-3xl font-bold text-gray-800">${totalCurrent}</p><p class="text-sm text-gray-500">Personel</p></div></div></div><div class="bg-gray-50 px-5 py-3 text-right"><span class="text-sm font-medium text-blue-600 hover:text-blue-800">Personel Listesi <i class="fas fa-arrow-right ml-1"></i></span></div>`;}
        if(card){card.addEventListener('click',()=>showModal(dir.id));grid.appendChild(card)}})}
        
        function showModal(id){currentDirectorateId=id;const dir=directorateData.find(d=>d.id===id);if(!dir)return;modalTitle.textContent=dir.name;if(dir.group==='kadastro'){const mersinKM=directorateData.find(d=>d.id==='mersin_km');populatePersonnelTable(mersinKM);document.querySelector('[data-tab="personnel"]').style.display='inline-flex';populatePersonnelList(getAggregatedPersonnel(),'mersin_km');}else{document.querySelector('[data-tab="personnel"]').style.display='none';populatePersonnelList(dir.personnelList||[],dir.id);}
        personnelSearchInput.value='';populateGallery(projectsGallery,dir.projects,'projects');populateGallery(photosGallery,dir.photos,'photos');switchTab(dir.group==='kadastro'?'personnel':'personnel-list');modal.classList.remove('hidden');document.body.style.overflow='hidden'}
        
        function populatePersonnelTable(dir){personnelTableBody.innerHTML='';personnelTableBody.dataset.id=dir.id;dir.personnel.forEach((p,index)=>{const difference=(p.current||0)-(p.norm||0);let diffClass='fark-sifir';if(difference>0)diffClass='fark-pozitif';if(difference<0)diffClass='fark-negatif';const row=document.createElement('tr');row.dataset.index=index;row.innerHTML=`<td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.title}</td><td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-sm"><div class="readonly-cell">${p.norm||0}</div></td><td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-sm"><div class="readonly-cell">${p.current||0}</div></td><td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-center fark-cell ${diffClass}">${difference>=0?'+':''}${difference}</td>`;personnelTableBody.appendChild(row)})}
        
        function populatePersonnelList(list,dirId){personnelListTableBody.innerHTML='';if(!list||list.length===0){personnelListTableBody.innerHTML=`<tr><td colspan="5" class="text-center py-10 text-gray-500">Bu birim için personel bilgisi bulunamadı.<br>Merkezi Yönetim Panelinden personel ekleyebilirsiniz.</td></tr>`;return}
        list.forEach((p,index)=>{const row=document.createElement('tr');row.dataset.index=index;row.dataset.dirId=dirId;row.innerHTML=createPersonnelRowView(p);personnelListTableBody.appendChild(row)})}
        
        function createPersonnelRowView(p){return` <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${p.name||''}</td> <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-600">${p.title||''}</td> <td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-600">${p.sicil||''}</td><td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-600">${p.görevliBirim||''}</td><td class="px-2 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-600">${p.ipTelefon||''}</td>`}
        
        function populateGallery(galleryElement,items,galleryType){galleryElement.innerHTML='';const uploadCard=document.createElement('div');uploadCard.className='upload-card';const acceptTypes=galleryType==='projects'?'image/*,application/pdf':'image/*';uploadCard.innerHTML=`<label for="${galleryType}-upload" class="text-center text-gray-500 cursor-pointer"><i class="fas fa-plus-circle fa-3x"></i><p class="mt-2 font-semibold">${galleryType==='projects'?'Dosya Yükle':'Resim Yükle'}</p></label><input type="file" id="${galleryType}-upload" class="hidden" multiple accept="${acceptTypes}">`;galleryElement.appendChild(uploadCard);document.getElementById(`${galleryType}-upload`).addEventListener('change',handleFileUpload);if(items&&items.length>0){items.forEach((item,index)=>{const galleryItem=document.createElement('div');galleryItem.className='gallery-item';if(item.type&&item.type.startsWith('image/')){galleryItem.innerHTML=`<img src="${item.url}" alt="${item.title}" class="w-full h-48 object-cover rounded-lg border-2 border-gray-200"><div class="delete-btn" data-index="${index}" data-type="${galleryType}"><i class="fas fa-trash-alt"></i></div>`}else if(item.type==='application/pdf'){galleryItem.innerHTML=`<div class="pdf-thumbnail"><i class="fas fa-file-pdf"></i><span>${item.title}</span></div><div class="delete-btn" data-index="${index}" data-type="${galleryType}"><i class="fas fa-trash-alt"></i></div>`}
        galleryItem.addEventListener('click',(e)=>{if(!e.target.closest('.delete-btn')){openLightbox(item)}});galleryElement.appendChild(galleryItem)})}}
        function handleFileUpload(event){const files=event.target.files;if(!files.length)return;const galleryType=event.target.id.includes('projects')?'projects':'photos';const dir=directorateData.find(d=>d.id===currentDirectorateId);if(!dir)return;for(const file of files){const reader=new FileReader();reader.onload=(e)=>{const newFile={title:file.name,url:e.target.result,type:file.type};if(!dir[galleryType])dir[galleryType]=[];dir[galleryType].push(newFile);saveData();populateGallery(document.getElementById(`${galleryType}-gallery`),dir[galleryType],galleryType)};reader.readAsDataURL(file)}}
        function handleDeleteFile(event){event.stopPropagation();if(!confirm("Bu dosyayı silmek istediğinizden emin misiniz?"))return;const button=event.currentTarget;const index=parseInt(button.dataset.index,10);const galleryType=button.dataset.type;const dir=directorateData.find(d=>d.id===currentDirectorateId);if(!dir||!dir[galleryType])return;dir[galleryType].splice(index,1);saveData();populateGallery(document.getElementById(`${galleryType}-gallery`),dir[galleryType],galleryType)}
        function openLightbox(item){lightboxContentWrapper.innerHTML='';resetZoomAndPan();if(item.type.startsWith('image/')){const img=document.createElement('img');img.id='lightbox-content';img.src=item.url;lightboxContentWrapper.appendChild(img);zoomControls.style.display='flex';addPanAndZoomListeners(img)}else if(item.type==='application/pdf'){const iframe=document.createElement('iframe');iframe.src=item.url;iframe.className='w-full h-full';lightboxContentWrapper.appendChild(iframe);zoomControls.style.display='none'}
        lightbox.classList.add('show');document.body.style.overflow='hidden'}
        function closeLightbox(){lightbox.classList.remove('show');document.body.style.overflow='auto';removePanAndZoomListeners()}
        function resetZoomAndPan(){currentZoom=1;isPanning=false;translateX=0;translateY=0}
        function addPanAndZoomListeners(element){element.addEventListener('mousedown',startPan);element.addEventListener('mousemove',pan);element.addEventListener('mouseup',endPan);element.addEventListener('mouseleave',endPan);element.addEventListener('wheel',handleWheelZoom)}
        function removePanAndZoomListeners(){const element=document.getElementById('lightbox-content');if(element){element.removeEventListener('mousedown',startPan);element.removeEventListener('mousemove',pan);element.removeEventListener('mouseup',endPan);element.removeEventListener('mouseleave',endPan);element.removeEventListener('wheel',handleWheelZoom)}}
        function applyZoomAndPan(){const element=document.getElementById('lightbox-content');if(element){element.style.transform=`translate(${translateX}px, ${translateY}px) scale(${currentZoom})`}}
        function zoom(direction){const zoomStep=0.2;if(direction==='in')currentZoom+=zoomStep;else if(direction==='out'&&currentZoom>zoomStep)currentZoom-=zoomStep;if(currentZoom<=1){currentZoom=1;translateX=0;translateY=0}
        applyZoomAndPan()}
        function handleWheelZoom(e){e.preventDefault();if(e.deltaY<0)zoom('in');else zoom('out')}
        function startPan(e){if(currentZoom<=1)return;e.preventDefault();isPanning=true;startX=e.clientX-translateX;startY=e.clientY-translateY;e.target.classList.add('panning')}
        function pan(e){if(!isPanning||currentZoom<=1)return;e.preventDefault();translateX=e.clientX-startX;translateY=e.clientY-startY;applyZoomAndPan()}
        function endPan(e){isPanning=false;if(e.target.classList)e.target.classList.remove('panning')}
        function exportToExcel(){const dir=directorateData.find(d=>d.id==='mersin_km');if(!dir||!dir.personnel)return;const dataToExport=dir.personnel.map(p=>({"Unvan":p.title,"Norm Kadro":p.norm||0,"Mevcut Personel":p.current||0,"Fark":(p.current||0)-(p.norm||0)}));const totalNorm=dataToExport.reduce((sum,item)=>sum+item["Norm Kadro"],0);const totalCurrent=dataToExport.reduce((sum,item)=>sum+item["Mevcut Personel"],0);dataToExport.push({"Unvan":"TOPLAM","Norm Kadro":totalNorm,"Mevcut Personel":totalCurrent,"Fark":totalCurrent-totalNorm});const ws=XLSX.utils.json_to_sheet(dataToExport);ws['!cols']=[{wch:30},{wch:15},{wch:15},{wch:10}];const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Personel Durumu");XLSX.writeFile(wb,`${dir.name}_Personel_Durumu.xlsx`)}
        function exportPersonnelListToExcel(){const dir=directorateData.find(d=>d.id===currentDirectorateId);if(!dir)return;let listToExport;let filename;if(dir.id==='mersin_km'){listToExport=getAggregatedPersonnel();filename=`Mersin_KM_Tum_Personel.xlsx`;}else{listToExport=dir.personnelList;filename=`${dir.name}_Personel_Listesi.xlsx`;}
        const dataToExport=listToExport.map((p,index)=>({"Sıra No":index+1,"Adı Soyadı":p.name,"Unvanı":p.title,"Sicil":p.sicil,"Görevli Olduğu Birim":p.görevliBirim,"IP Telefon":p.ipTelefon}));const ws=XLSX.utils.json_to_sheet(dataToExport);ws['!cols']=[{wch:10},{wch:30},{wch:40},{wch:15},{wch:30},{wch:20}];const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Personel Listesi");XLSX.writeFile(wb,filename)}
        function hideModal(){modal.classList.add('hidden');document.body.style.overflow='auto';currentDirectorateId=null}
        function switchTab(tabId){modalTabs.querySelectorAll('button').forEach(btn=>{const targetTab=btn.dataset.tab;if(targetTab===tabId){btn.classList.add('nav-active','border-blue-500','text-blue-600');btn.classList.remove('border-transparent','text-gray-500','hover:text-gray-700','hover:border-gray-300')}else{btn.classList.remove('nav-active','border-blue-500','text-blue-600');btn.classList.add('border-transparent','text-gray-500','hover:text-gray-700','hover:border-gray-300')}});tabPanes.forEach(pane=>{pane.id===`${tabId}-content`?pane.classList.remove('hidden'):pane.classList.add('hidden')})}
        
        // --- Merkezi Personel Yönetim Fonksiyonları ---
        function populateAllPersonnelTable() {
            const searchTerm = normalizeString(allPersonnelSearchInput.value);
            const allPersonnel = getAggregatedPersonnel();
            const filteredList = allPersonnel.filter(p => normalizeString(p.name).includes(searchTerm) || normalizeString(p.title).includes(searchTerm) || normalizeString(p.sicil?.toString()).includes(searchTerm) || normalizeString(p.directorateName).includes(searchTerm));
            allPersonnelTableBody.innerHTML = '';
            if (filteredList.length === 0) {
                allPersonnelTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-10 text-gray-500">Arama kriterlerine uygun personel bulunamadı.</td></tr>`;
                return;
            }
            filteredList.forEach(p => {
                const row = document.createElement('tr');
                row.dataset.dirId = p.directorateId;
                row.dataset.index = p.originalIndex;
                row.dataset.sicil = p.sicil;
                row.innerHTML = createAllPersonnelRowView(p);
                allPersonnelTableBody.appendChild(row);
            });
            updateBulkDeleteButton();
        }
        function createAllPersonnelRowView(p) {
            return `
                <td class="px-2 py-3 sm:px-4"><input type="checkbox" class="personnel-checkbox" data-sicil="${p.sicil || ''}"></td>
                <td class="px-2 py-3 sm:px-6 whitespace-nowrap text-sm font-semibold text-gray-900">${p.name || ''}</td>
                <td class="px-2 py-3 sm:px-6 whitespace-nowrap text-sm text-gray-600">${p.title || ''}</td>
                <td class="px-2 py-3 sm:px-6 whitespace-nowrap text-sm text-gray-600">${p.sicil || ''}</td>
                <td class="px-2 py-3 sm:px-6 whitespace-nowrap text-sm text-gray-600 font-medium">${p.directorateName || ''}</td>
                <td class="px-2 py-3 sm:px-6 whitespace-nowrap text-sm text-gray-600">${p.görevliBirim || ''}</td>
                <td class="px-2 py-3 sm:px-6 whitespace-nowrap text-sm text-gray-600">${p.ipTelefon || ''}</td>
                <td class="px-2 py-3 sm:px-6 whitespace-nowrap text-center text-sm font-medium">
                    <button class="action-btn edit-btn" data-action="edit" title="Düzenle"><i class="fas fa-pencil-alt"></i></button>
                    <button class="action-btn delete-btn-action" data-action="delete" title="Sil"><i class="fas fa-trash-alt"></i></button>
                </td>`;
        }
        function createAllPersonnelRowEdit(p,isNew=false){const directorateOptions=directorateData.map(dir=>`<option value="${dir.id}" ${p.directorateId===dir.id?'selected':''}>${dir.name}</option>`).join('');return`<td class="px-4 py-4"></td><td class="px-2 py-2"><input type="text" class="personnel-list-input" data-field="name" value="${p.name||''}" placeholder="Adı Soyadı"></td><td class="px-2 py-2"><input type="text" class="personnel-list-input" data-field="title" value="${p.title||''}" placeholder="Unvanı"></td><td class="px-2 py-2"><input type="text" class="personnel-list-input" data-field="sicil" value="${p.sicil||''}" placeholder="Sicil No"></td><td class="px-2 py-2"><select class="personnel-list-input" data-field="directorateId">${directorateOptions}</select></td><td class="px-2 py-2"><input type="text" class="personnel-list-input" data-field="görevliBirim" value="${p.görevliBirim||''}" placeholder="Görev Birimi"></td><td class="px-2 py-2"><input type="text" class="personnel-list-input" data-field="ipTelefon" value="${p.ipTelefon||''}" placeholder="IP Telefon"></td><td class="px-2 py-2 whitespace-nowrap text-center text-sm font-medium"><button class="action-btn save-btn" data-action="save" title="Kaydet"><i class="fas fa-check"></i></button><button class="action-btn cancel-btn" data-action="cancel" title="İptal"><i class="fas fa-times"></i></button></td>`}
        
        function handleAllPersonnelListAction(e){const button=e.target.closest('button.action-btn');if(!button)return;const action=button.dataset.action;const row=button.closest('tr');const dirId=row.dataset.dirId;const sicil=row.dataset.sicil;const isNew=!row.hasAttribute('data-sicil');if(action==='edit'){const allPersonnel=getAggregatedPersonnel();const person=allPersonnel.find(p=>p.sicil===sicil);if(person){row.innerHTML=createAllPersonnelRowEdit(person)}}else if(action==='save'){const inputs=row.querySelectorAll('.personnel-list-input');const newPersonData={};let newDirId=dirId;inputs.forEach(input=>{const field=input.dataset.field;if(field==='directorateId'){newDirId=input.value}else{newPersonData[field]=input.value}});if(!newPersonData.sicil){alert("Sicil numarası boş bırakılamaz.");return}
        let originalDir=directorateData.find(d=>d.id===dirId);let personIndex=originalDir?originalDir.personnelList.findIndex(p=>p.sicil===sicil):-1;if(isNew){personIndex=-1}
        if(personIndex>-1){if(originalDir.id===newDirId){originalDir.personnelList[personIndex]=newPersonData}else{originalDir.personnelList.splice(personIndex,1);const newDir=directorateData.find(d=>d.id===newDirId);if(newDir){if(!newDir.personnelList)newDir.personnelList=[];newDir.personnelList.push(newPersonData)}}}else{const targetDir=directorateData.find(d=>d.id===newDirId);if(targetDir){if(!targetDir.personnelList)targetDir.personnelList=[];targetDir.personnelList.push(newPersonData)}}
        recalculateCurrentPersonnelCounts();saveData();refreshAllViews();populateAllPersonnelTable()}else if(action==='delete'){if(button.classList.contains('confirm-delete')){const dir=directorateData.find(d=>d.id===dirId);if(dir&&dir.personnelList){const personIndex=dir.personnelList.findIndex(p=>p.sicil===sicil);if(personIndex>-1){dir.personnelList.splice(personIndex,1);recalculateCurrentPersonnelCounts();saveData();refreshAllViews();populateAllPersonnelTable()}}}else{button.innerHTML='<i class="fas fa-check"></i> Onayla';button.classList.add('confirm-delete');setTimeout(()=>{if(button){button.innerHTML='<i class="fas fa-trash-alt"></i>';button.classList.remove('confirm-delete')}},3000)}}else if(action==='cancel'){if(isNew){row.remove()}else{populateAllPersonnelTable()}}}
        
        function handleAllPersonnelExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);

                    updatePersonnelFromData(json);
                    
                    saveData();
                    refreshAllViews();
                    populateAllPersonnelTable();
                    alert("Personel listesi başarıyla yüklendi ve güncellendi.");

                } catch (err) {
                    console.error("Toplu personel yükleme hatası:", err);
                    alert("Excel dosyası işlenirken bir hata oluştu. Lütfen şablonu ve veri formatını kontrol edin.");
                } finally {
                    importAllPersonnelExcelInput.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function exportAllPersonnelToExcel(){const allPersonnel=getAggregatedPersonnel();if(allPersonnel.length===0){alert("Dışa aktarılacak personel bulunmamaktadır.");return}
        const dataToExport=allPersonnel.map(p=>({"Adı Soyadı":p.name,"Unvanı":p.title,"Sicil":p.sicil,"Birim Adı":p.directorateName,"Görevli Olduğu Birim":p.görevliBirim,"IP Telefon":p.ipTelefon}));const ws=XLSX.utils.json_to_sheet(dataToExport);ws['!cols']=[{wch:30},{wch:40},{wch:15},{wch:30},{wch:30},{wch:20}];const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Tüm Personel Listesi");XLSX.writeFile(wb,`Mersin_KM_Tum_Personel_Listesi.xlsx`)}
        
        function downloadNormTemplateForGroup(groupType){
            const mersinKM = directorateData.find(dir => dir.id === 'mersin_km');
            if (!mersinKM) return;
            let templateData = mersinKM.personnel.map(p => {
                return {"Birim_Adi": mersinKM.name, "Unvan": p.title, "Norm_Sayisi": p.norm};
            });
            const ws=XLSX.utils.json_to_sheet(templateData,{header:["Birim_Adi","Unvan","Norm_Sayisi"]});
            ws['!cols']=[{wch:40},{wch:30},{wch:15}];const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Norm Kadro Şablonu");XLSX.writeFile(wb,`Norm_Kadro_Mersin_KM_Sablonu.xlsx`)}
        
        function handleNormExcelUpload(event){
            const file=event.target.files[0];
            if(!file)return;
            const reader=new FileReader();
            reader.onload=(e)=>{
                try{
                    const data=new Uint8Array(e.target.result);
                    const workbook=XLSX.read(data,{type:'array'});
                    const firstSheetName=workbook.SheetNames[0];
                    const worksheet=workbook.Sheets[firstSheetName];
                    const json=XLSX.utils.sheet_to_json(worksheet);
                    
                    updateNormsFromData(json);
                    recalculateCurrentPersonnelCounts();
                    
                    saveData();
                    refreshAllViews();
                    normUploadReport.classList.remove('hidden');
                    normUploadReport.innerHTML=`<p class="font-bold text-green-700">Norm kadro başarıyla güncellendi.</p>`;
                   }catch(err){
                       console.error("Excel dosyası okunurken hata:",err);
                       alert("Excel dosyası okunurken bir hata oluştu. Lütfen dosya formatını kontrol edin.")
                   }finally{
                       normExcelInput.value=''
                   }
            };
            reader.readAsArrayBuffer(file);
        }

        function refreshAllViews(){renderSummaryDashboard();renderAllCards()}
        function switchCentralTab(tabId){centralModalTabs.querySelectorAll('button').forEach(btn=>{const targetTab=btn.dataset.tab;if(targetTab===tabId){btn.classList.add('nav-active','border-blue-500','text-blue-600');btn.classList.remove('border-transparent','text-gray-500','hover:text-gray-700','hover:border-gray-300')}else{btn.classList.remove('nav-active','border-blue-500','text-blue-600');btn.classList.add('border-transparent','text-gray-500','hover:text-gray-700','hover:border-gray-300')}});centralTabPanes.forEach(pane=>{pane.id===`${tabId}-content`?pane.classList.remove('hidden'):pane.classList.add('hidden')})}
        
        function updateBulkDeleteButton() {
            const checkedBoxes = allPersonnelTableBody.querySelectorAll('.personnel-checkbox:checked');
            const count = checkedBoxes.length;
            bulkDeleteCount.textContent = count;
            bulkDeleteBtn.disabled = count === 0;
            const allBoxes = allPersonnelTableBody.querySelectorAll('.personnel-checkbox');
            selectAllPersonnelCheckbox.checked = allBoxes.length > 0 && count === allBoxes.length;
        }
        
        // --- Olay Dinleyicileri ---
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        closeModalBtn.addEventListener('click',hideModal);modal.addEventListener('click',(e)=>{if(e.target===modal)hideModal()});
        document.addEventListener('keydown',(e)=>{if(e.key==='Escape'){hideModal();allPersonnelModal.classList.add('hidden');document.body.style.overflow='auto';closeLightbox();}});
        modalTabs.addEventListener('click',(e)=>{const button=e.target.closest('button');if(button&&button.dataset.tab)switchTab(button.dataset.tab)});
        exportExcelBtn.addEventListener('click',exportToExcel);
        personnelSearchInput.addEventListener('input',(e)=>{
            const searchTerm=normalizeString(e.target.value);
            const dir=directorateData.find(d=>d.id===currentDirectorateId);
            if(!dir) return;
            let listToFilter = [];
            if (dir.id === 'mersin_km') {
                listToFilter = getAggregatedPersonnel();
            } else {
                listToFilter = dir.personnelList;
            }
            if(listToFilter){
                const filteredList=listToFilter.filter(p=>normalizeString(p.name).includes(searchTerm)||normalizeString(p.title).includes(searchTerm)||(p.sicil&&normalizeString(p.sicil.toString()).includes(searchTerm)));
                populatePersonnelList(filteredList,dir.id)
            }
        });
        exportPersonnelListExcelBtn.addEventListener('click',exportPersonnelListToExcel);
        lightboxCloseBtn.addEventListener('click',closeLightbox);zoomInBtn.addEventListener('click',()=>zoom('in'));zoomOutBtn.addEventListener('click',()=>zoom('out'));
        closeAllPersonnelModalBtn.addEventListener('click',()=>{allPersonnelModal.classList.add('hidden');document.body.style.overflow='auto'});
        allPersonnelModal.addEventListener('click',(e)=>{if(e.target===allPersonnelModal){allPersonnelModal.classList.add('hidden');document.body.style.overflow='auto'}});
        allPersonnelSearchInput.addEventListener('input',populateAllPersonnelTable);
        allPersonnelTableBody.addEventListener('click',handleAllPersonnelListAction);
        addAllPersonnelBtn.addEventListener('click',()=>{const newRow=document.createElement('tr');newRow.innerHTML=createAllPersonnelRowEdit({},true);allPersonnelTableBody.insertBefore(newRow,allPersonnelTableBody.firstChild)});
        importAllPersonnelExcelBtn.addEventListener('click',()=>importAllPersonnelExcelInput.click());
        importAllPersonnelExcelInput.addEventListener('change',handleAllPersonnelExcelImport);
        exportAllPersonnelExcelBtn.addEventListener('click',exportAllPersonnelToExcel);
        centralModalTabs.addEventListener('click', (e) => { const button = e.target.closest('button'); if (button && button.dataset.tab) { switchCentralTab(button.dataset.tab); } });
        normTemplateButtons.forEach(btn=>{btn.addEventListener('click',(e)=>{const group=e.currentTarget.dataset.group;downloadNormTemplateForGroup(group)})});
        normUploadButtons.forEach(btn=>{btn.addEventListener('click',(e)=>{normExcelInput.click()})});
        normExcelInput.addEventListener('change',handleNormExcelUpload);
        allPersonnelTableBody.addEventListener('change', (e) => {
            if (e.target.classList.contains('personnel-checkbox')) {
                updateBulkDeleteButton();
            }
        });
        selectAllPersonnelCheckbox.addEventListener('change', (e) => {
            allPersonnelTableBody.querySelectorAll('.personnel-checkbox').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            updateBulkDeleteButton();
        });
        bulkDeleteBtn.addEventListener('click', () => {
            const checkedBoxes = allPersonnelTableBody.querySelectorAll('.personnel-checkbox:checked');
            const count = checkedBoxes.length;
            if (count === 0) return;

            if (confirm(`${count} adet personel kalıcı olarak silinecektir. Emin misiniz?`)) {
                const sicilsToDelete = new Set();
                checkedBoxes.forEach(box => {
                    sicilsToDelete.add(box.dataset.sicil);
                });

                directorateData.forEach(dir => {
                    dir.personnelList = dir.personnelList.filter(p => !sicilsToDelete.has(String(p.sicil)));
                });

                recalculateCurrentPersonnelCounts();
                saveData();
                refreshAllViews();
                populateAllPersonnelTable();
            }
        });

    </script>
</body>
</html>
