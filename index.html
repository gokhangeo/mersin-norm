<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mersin Kadastro Müdürlüğü - Birim Yönetim Portalı</title>
    <link rel="icon" type="image/png" href="https://placehold.co/64x64/002d72/ffffff?text=TKGM">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #0f172a; }
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px); }
        .modal-content { max-height: 90vh; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.2); }
        
        .modern-card { 
            background: white; 
            border: 1px solid #e2e8f0; 
            border-radius: 1rem; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .modern-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1);
            border-color: #3b82f6;
        }

        .nav-active { color: #3b82f6 !important; border-bottom: 3px solid #3b82f6; font-weight: 800 !important; }
        .group-header { border-left: 6px solid #1e3a8a; padding-left: 1rem; margin-bottom: 1.5rem; }

        .progress-bar-container { height: 10px; background-color: #f1f5f9; border-radius: 10px; overflow: hidden; border: 1px solid #e2e8f0; }
        .progress-bar { height: 100%; transition: width 1s ease-in-out; border-radius: 10px; }
        
        #connection-status { 
            position: fixed; bottom: 1.5rem; left: 1.5rem; z-index: 100; 
            font-size: 0.75rem; font-weight: 800; padding: 0.6rem 1.25rem; 
            border-radius: 2rem; text-transform: uppercase; letter-spacing: 0.05em;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .status-ok { background: #dcfce7; color: #166534; }
        .status-loading { background: #fef9c3; color: #854d0e; }
        .status-hidden { opacity: 0; transform: translateY(20px); pointer-events: none; }

        .gender-box { width: 30px; height: 30px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 14px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
        .gender-male { background-color: #e0f2fe; color: #0369a1; }
        .gender-female { background-color: #fce7f3; color: #be185d; }

        .distribution-table th { background-color: #1e3a8a; color: white; font-size: 0.7rem; padding: 10px; }
        .distribution-table td { font-size: 0.8rem; padding: 8px; border: 1px solid #e2e8f0; text-align: center; }
        .distribution-table .unit-name { text-align: left; font-weight: bold; background-color: #f8fafc; }
    </style>
</head>
<body class="antialiased">

    <header class="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm">
        <div class="container mx-auto px-6 lg:px-12">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-blue-950 rounded-xl flex items-center justify-center text-white font-black text-xl shadow-lg shadow-blue-900/20">TK</div>
                    <div>
                        <h1 class="text-xl font-black tracking-tighter text-slate-900 leading-none uppercase">Birim Yönetim Portalı</h1>
                        <p class="text-[9px] font-extrabold text-blue-600 uppercase tracking-[0.25em] mt-1 italic">Mersin Kadastro Müdürlüğü</p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="hidden md:flex flex-col items-end text-right">
                        <span class="text-xs font-black text-slate-600">© Gökhan ELGÜL tarafından tasarlanmıştır.</span>
                    </div>
                    <input type="file" id="manual-file-upload" class="hidden" accept=".xlsx, .xls" multiple>
                    <button onclick="document.getElementById('manual-file-upload').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl text-xs font-bold uppercase tracking-widest transition-all transform active:scale-95 flex items-center gap-2 shadow-xl shadow-blue-600/20">
                        <i class="fas fa-file-excel"></i> Veri Güncelle
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 lg:px-12 py-8 space-y-12">
        <section>
            <div class="group-header">
                <h2 class="text-lg font-black text-slate-800 uppercase tracking-tight text-blue-900 italic">Genel Müdürlük Analizi</h2>
            </div>
            <div id="summary-dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6"></div>
        </section>
        
        <section>
            <div class="group-header">
                <h2 class="text-lg font-black text-slate-800 uppercase tracking-tight text-blue-900 italic">Müdürlük Verileri</h2>
            </div>
            <div id="kadastro-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6"></div>
        </section>
        
        <section>
            <div class="group-header">
                <h2 class="text-lg font-black text-slate-800 uppercase tracking-tight text-blue-900 italic">Bağlı Kadastro Birimleri</h2>
            </div>
            <div id="ilce-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6 text-center"></div>
        </section>
    </main>

    <div id="connection-status" class="status-loading">
        <i class="fas fa-sync-alt fa-spin mr-2"></i> <span>Veriler Senkronize Ediliyor...</span>
    </div>

    <!-- Detay Modalı -->
    <div id="detail-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white shadow-2xl w-full max-w-6xl flex flex-col modal-content overflow-hidden border-2 border-slate-900">
            <div class="flex items-center justify-between p-5 bg-slate-900 text-white shadow-lg">
                <div class="flex items-center gap-4">
                    <div class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center text-white font-bold italic shadow-inner">TK</div>
                    <h3 id="modal-title" class="text-lg font-black uppercase tracking-tight italic">Birim Bilgileri</h3>
                </div>
                <button id="close-modal-btn" class="w-10 h-10 rounded-full hover:bg-white/20 text-white transition flex items-center justify-center"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="flex-grow p-6 overflow-y-auto bg-slate-50">
                <nav id="modal-tabs" class="flex space-x-10 border-b-2 border-slate-200 mb-8 text-slate-400 font-black uppercase text-[10px] tracking-widest">
                    <button data-tab="personnel" class="pb-3 border-b-4 border-transparent transition-all">Personel Normu</button>
                    <button data-tab="personnel-list" class="pb-3 border-b-4 border-transparent transition-all">İsim Listesi</button>
                </nav>
                <div id="tab-content">
                    <div id="personnel-content" class="tab-pane">
                        <div class="overflow-hidden rounded-2xl border border-slate-200 shadow-xl bg-white text-xs text-xs">
                            <table class="w-full text-left">
                                <thead class="bg-slate-900 text-white font-black uppercase text-[9px] tracking-widest">
                                    <tr><th class="p-5">Kadro Unvanı</th><th class="p-5 text-center">Norm</th><th class="p-5 text-center">Mevcut</th><th class="p-5 text-center">Fark</th></tr>
                                </thead>
                                <tbody id="personnel-table-body" class="divide-y divide-slate-100 font-bold text-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="personnel-list-content" class="tab-pane hidden space-y-4">
                        <input type="text" id="personnel-search-input" placeholder="Hızlı ara..." class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl outline-none focus:border-blue-500 font-black text-sm shadow-sm transition-all">
                        <div class="rounded-2xl border border-slate-200 overflow-hidden shadow-xl bg-white text-xs">
                            <table class="w-full text-left">
                                <thead class="bg-slate-100 text-slate-600 font-black uppercase text-[9px]">
                                    <tr><th class="p-5 text-left">Adı Soyadı</th><th class="p-5">Unvan</th><th class="p-5 text-center">Sicil</th><th class="p-5">Görev Yeri</th><th class="p-5">IP Telefon</th></tr>
                                </thead>
                                <tbody id="personnel-list-table-body" class="divide-y divide-slate-50 font-medium"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Merkezi Yönetim Modalı -->
    <div id="all-personnel-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white shadow-2xl w-full max-w-7xl flex flex-col modal-content overflow-hidden border-2 border-slate-900 rounded-2xl">
            <div class="p-6 bg-slate-950 text-white flex justify-between items-center shadow-xl">
                <div>
                    <h3 class="text-xl font-black uppercase tracking-tight italic">MERKEZİ VERİ YÖNETİMİ</h3>
                    <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1">Konsolide Personel Havuzu</p>
                </div>
                <button id="close-all-personnel-modal-btn" class="w-10 h-10 rounded-full hover:bg-white/10 text-white transition flex items-center justify-center"><i class="fas fa-times fa-2x"></i></button>
            </div>
            <div class="p-6 flex-grow flex flex-col overflow-hidden bg-slate-50">
                <div id="central-modal-tabs" class="flex gap-10 border-b-2 border-slate-200 mb-6 font-black uppercase text-[10px] tracking-widest">
                    <button data-tab="central-personnel-list" class="pb-2 border-b-4 border-transparent transition-all">Tüm Kayıtlar</button>
                    <button data-tab="central-title-distribution" class="pb-2 border-b-4 border-transparent transition-all">Dağılım Matrisi</button>
                </div>
                <div id="central-tab-content" class="flex-grow overflow-y-auto">
                    <div id="central-personnel-list-content" class="central-tab-pane text-xs">
                        <input type="text" id="all-personnel-search-input" placeholder="Tüm personelde hızlı arama..." class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl mb-4 outline-none focus:border-blue-500 font-black shadow-sm">
                        <div class="rounded-2xl border border-slate-100 overflow-hidden shadow-xl bg-white">
                            <table class="w-full text-xs">
                                <thead class="bg-slate-900 text-white sticky top-0 font-black uppercase text-[8px] z-10 border-b-4 border-blue-600">
                                    <tr><th class="p-4 text-left">Adı Soyadı</th><th class="p-4 text-center">Figür</th><th class="p-4 text-left">Unvan</th><th class="p-4 text-left">Sicil</th><th class="p-4 text-left">Birim</th><th class="p-4 text-left">Görev Yeri</th><th class="p-4 text-left">IP Telefon</th></tr>
                                </thead>
                                <tbody id="all-personnel-table-body" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="central-title-distribution-content" class="central-tab-pane hidden">
                        <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-xl bg-white">
                            <table class="w-full distribution-table border-collapse">
                                <thead id="title-distribution-thead"></thead>
                                <tbody id="title-distribution-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GITHUB PARÇALI API ---
        const _p1 = "ghp_jA0Y2j";
        const _p2 = "qexcZgdcIu6F";
        const _p3 = "glCOcaKo1us";
        const _p4 = "0070QYf";

        const GITHUB_CONFIG = {
            owner: 'gokhangeo',
            repo: 'mersin-norm',
            branch: 'main',
            token: _p1 + _p2 + _p3 + _p4,
            files: { personnel: 'personnel.json', norm: 'norm.json' }
        };

        const CONFIG = {
            units: ['MERKEZ', 'ANAMUR', 'ERDEMLİ', 'MUT', 'SİLİFKE', 'TARSUS'],
            titles: ["Kadastro Müdürü", "Kadastro Müdür Yrd.", "Kadastro Üyesi", "Mühendis", "Teknisyen/Tekniker", "İşlem Yapan Personel", "Arşiv Görevlisi", "Destek Personeli", "Şoför", "Güvenlik Personeli"]
        };

        let directorateData = [];
        let allPersonnelMaster = []; 
        let els = {};
        const GENDER_ICONS = {
            E: `<span class="gender-box gender-male shadow-sm"><i class="fas fa-user-tie"></i></span>`,
            K: `<span class="gender-box gender-female shadow-sm"><i class="fas fa-user-graduate"></i></span>`
        };

        function normalizeKey(s) {
            if (!s) return '';
            return s.toString().trim().toLocaleLowerCase('tr-TR')
                .replace(/İ/g, 'i').replace(/I/g, 'i').replace(/ı/g, 'i')
                .replace(/Ğ/g, 'g').replace(/ğ/g, 'g')
                .replace(/Ü/g, 'u').replace(/ü/g, 'u')
                .replace(/Ş/g, 's').replace(/ş/g, 's')
                .replace(/Ö/g, 'o').replace(/ö/g, 'o')
                .replace(/Ç/g, 'c').replace(/ç/g, 'c')
                .replace(/[^a-z0-9]/g, '');
        }

        async function fetchFromGithub(fileName) {
            const url = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${fileName}?v=${Date.now()}`;
            try {
                const res = await fetch(url);
                if (res.ok) return await res.json();
            } catch(e) {}
            return null;
        }

        async function saveToGithub(fileName, data) {
            const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${fileName}`;
            let sha = "";
            try {
                const getRes = await fetch(apiUrl, { headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` } });
                if (getRes.ok) { const fd = await getRes.json(); sha = fd.sha; }
            } catch(e) {}

            const body = {
                message: `Update ${fileName}`,
                content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))),
                branch: GITHUB_CONFIG.branch,
                sha: sha || undefined
            };

            await fetch(apiUrl, { method: 'PUT', headers: { 'Authorization': `token ${GITHUB_CONFIG.token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        }

        async function init() {
            els = {
                summary: document.getElementById('summary-dashboard'),
                kadastroGrid: document.getElementById('kadastro-grid'),
                ilceGrid: document.getElementById('ilce-grid'),
                detailModal: document.getElementById('detail-modal'),
                modalTitle: document.getElementById('modal-title'),
                persTable: document.getElementById('personnel-table-body'),
                persList: document.getElementById('personnel-list-table-body'),
                allPersTable: document.getElementById('all-personnel-table-body'),
                search: document.getElementById('personnel-search-input'),
                manualUpload: document.getElementById('manual-file-upload'),
                status: document.getElementById('connection-status'),
                closeModalBtn: document.getElementById('close-modal-btn'),
                closeAllModalBtn: document.getElementById('close-all-personnel-modal-btn'),
                modalTabs: document.getElementById('modal-tabs')
            };

            directorateData = [
                { id: 'mersin_km', name: 'MERSİN KADASTRO MÜDÜRLÜĞÜ', group: 'kadastro', personnel: [], personnelList: [] },
                ...CONFIG.units.map(u => ({ id: `${normalizeKey(u)}_kb`, name: `${u} KADASTRO BİRİMİ`, group: 'ilce', personnel: [], personnelList: [] }))
            ];
            
            setupEventListeners();
            await loadAll();
        }

        async function loadAll() {
            const personnel = await fetchFromGithub(GITHUB_CONFIG.files.personnel);
            const norms = await fetchFromGithub(GITHUB_CONFIG.files.norm);
            
            if (norms && Array.isArray(norms)) {
                const km = directorateData.find(d => d.id === 'mersin_km');
                km.personnel = norms.map(r => ({ title: r.t, norm: parseInt(r.n) || 0, fixedCurrent: parseInt(r.v) || 0, current: 0 }));
            }
            if (personnel && Array.isArray(personnel)) {
                allPersonnelMaster = personnel; 
                processPersonnelToUnits();
            }
            
            refreshUI();
            updateStatus(!!(personnel && norms), (personnel && norms) ? "GÜNCEL VERİLER AKTİF" : "LÜTFEN VERİ YÜKLEYİN");
        }

        function processPersonnelToUnits() {
            directorateData.forEach(d => d.personnelList = []);
            allPersonnelMaster.forEach(r => {
                const person = { name: r.n, title: r.t, sicil: r.s, gy: r.gy || 'Mersin', c: r.c, tel: r.tel || '' };
                const nb = normalizeKey(person.gy);
                let target;
                if (nb === '' || nb.includes('merkez') || nb.includes('mersin')) target = directorateData.find(d => d.id === 'merkez_kb');
                else target = directorateData.find(d => nb.includes(normalizeKey(d.name.split(' ')[0])));
                if (!target) target = directorateData.find(d => d.id === 'merkez_kb');
                target.personnelList.push(person);
            });
            recalcNorms();
        }

        function recalcNorms() {
            const km = directorateData.find(d => d.id === 'mersin_km');
            if(!km || !km.personnel.length) return;
            km.personnel.forEach(p => p.current = 0);
            
            allPersonnelMaster.forEach(p => {
                const pt = normalizeKey(p.t);
                let mapped = false;
                const groups = [
                    {m:'muhendis',t:'Mühendis'}, {m:'teknik',t:'Teknisyen/Tekniker'},
                    {m:'teknis',t:'Teknisyen/Tekniker'}, {m:'kontrol',t:'Teknisyen/Tekniker'},
                    {m:'bilgisayar',t:'İşlem Yapan Personel'}, {m:'memur',t:'İşlem Yapan Personel'},
                    {m:'isci',t:'Destek Personeli'}, {m:'işçi',t:'Destek Personeli'}, {m:'guvenlik',t:'Güvenlik Personeli'}
                ];
                for (const g of groups) { if (pt.includes(g.m)) { const e = km.personnel.find(x => x.title === g.t); if(e) { e.current++; mapped = true; break; } } }
                if (!mapped) { const d = km.personnel.find(x => normalizeKey(x.title) === pt); if (d) d.current++; }
            });
            km.personnel.forEach(p => { if(p.fixedCurrent > 0) p.current = p.fixedCurrent; });
        }

        function refreshUI() {
            const km = directorateData.find(d => d.id === 'mersin_km');
            const nTotal = km.personnel.reduce((s,p)=>s+p.norm, 0);
            const cTotal = km.personnel.reduce((s,p)=>s+p.current, 0) || allPersonnelMaster.length;
            const rate = nTotal > 0 ? Math.round((cTotal/nTotal)*100) : 0;

            els.summary.innerHTML = `
                <div class="xl:col-span-3 modern-card p-6 border-l-[12px] border-blue-900 flex flex-col justify-between bg-gradient-to-r from-blue-50/50 to-white">
                    <div>
                        <p class="text-[9px] font-black text-blue-600 uppercase mb-1 tracking-widest leading-none">ANALİZ ÖZETİ</p>
                        <h3 class="text-xl font-black text-slate-900 uppercase italic leading-none">MERSİN KADASTRO MÜDÜRLÜĞÜ</h3>
                        <div class="mt-4"><div class="flex justify-between text-[9px] font-black uppercase text-slate-400 mb-1"><span>DOLULUK</span><b>${rate}%</b></div><div class="progress-bar-container"><div class="progress-bar bg-blue-600" style="width:${rate}%"></div></div></div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 mt-6 pt-4 border-t border-slate-100 text-center">
                        <div><p class="text-[9px] font-bold text-slate-400 uppercase">NORM</p><p class="text-2xl font-black text-slate-900 leading-none">${nTotal}</p></div>
                        <div><p class="text-[9px] font-bold text-slate-400 uppercase">FİİLİ</p><p class="text-2xl font-black text-slate-900 leading-none">${cTotal}</p></div>
                        <div class="bg-blue-600 rounded-2xl py-2 shadow-lg"><p class="text-[9px] font-bold text-white uppercase opacity-70 leading-none mb-1">FARK</p><p class="text-2xl font-black text-white leading-none">${cTotal-nTotal>=0?'+':''}${cTotal-nTotal}</p></div>
                    </div>
                </div>
                <div onclick="openCentral()" class="xl:col-span-2 modern-card p-6 cursor-pointer group flex flex-col justify-between hover:bg-slate-50 transition-all">
                    <div class="flex justify-between items-center"><p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">YÖNETİM</p><i class="fas fa-users-cog text-xl text-blue-200 group-hover:rotate-90 transition-transform"></i></div>
                    <div class="text-center py-4"><p class="text-5xl font-black text-slate-900 tracking-tighter">${cTotal}</p><p class="text-[10px] font-black uppercase text-slate-400 tracking-widest mt-1">Toplam Personel</p></div>
                    <div class="text-center text-blue-600 text-[10px] font-black uppercase pt-3 border-t">Havuza Git →</div>
                </div>`;

            [els.kadastroGrid, els.ilceGrid].forEach(g => g.innerHTML = '');
            directorateData.forEach(d => {
                const grid = document.getElementById(`${d.group}-grid`);
                const card = document.createElement('div');
                card.className = (d.group==='kadastro'?'xl:col-span-2':'') + ' modern-card p-5 cursor-pointer group flex flex-col items-center justify-center';
                if (d.group === 'kadastro') {
                    const dn = d.personnel.reduce((s,p)=>s+p.norm, 0), dc = d.personnel.reduce((s,p)=>s+p.current, 0), dr = dn>0?Math.round((dc/dn)*100):0;
                    card.innerHTML = `<h4 class="font-black text-slate-800 uppercase text-xs mb-5">${d.name}</h4><div class="w-full px-2"><div class="progress-bar-container"><div class="progress-bar ${dr>=100?'bg-emerald-500':'bg-amber-500'}" style="width:${dr}%"></div></div></div><div class="flex justify-between w-full px-4 mt-3 text-[9px] font-black text-slate-400 uppercase tracking-widest"><span>N: ${dn}</span><span>M: ${dc}</span></div>`;
                } else {
                    card.innerHTML = `<h4 class="font-black text-slate-700 text-[10px] mb-5 uppercase tracking-tighter text-center leading-tight h-10 flex items-center group-hover:text-blue-600 transition-colors">${d.name}</h4><div class="flex items-center gap-4"><div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center text-blue-400 shadow-inner group-hover:bg-blue-600 group-hover:text-white transition-all"><i class="fas fa-users-rectangle text-lg"></i></div><span class="text-3xl font-black text-slate-900 tracking-tighter">${d.personnelList.length}</span></div>`;
                }
                card.onclick = () => showModal(d.id);
                grid.appendChild(card);
            });
        }

        function getHierarchicalSort(list) {
            return list.sort((a, b) => {
                let idxA = CONFIG.titles.indexOf(a.title || a.t);
                let idxB = CONFIG.titles.indexOf(b.title || b.t);
                if (idxA === -1) idxA = 99;
                if (idxB === -1) idxB = 99;
                return idxA - idxB;
            });
        }

        function populateTitleDistribution() {
            const thead = document.getElementById('title-distribution-thead');
            const tbody = document.getElementById('title-distribution-tbody');
            const titles = CONFIG.titles;
            const units = directorateData.filter(d => d.id !== 'mersin_km');

            thead.innerHTML = `<tr><th class="unit-name">Birim Adı</th>${titles.map(t => `<th>${t}</th>`).join('')}<th>TOPLAM</th></tr>`;
            tbody.innerHTML = '';

            units.forEach(u => {
                const unitMatch = normalizeKey(u.name.split(' ')[0]);
                const unitPersonnel = allPersonnelMaster.filter(r => {
                    const personGY = normalizeKey(r.gy || 'Mersin');
                    if (unitMatch === 'merkez') return personGY === '' || personGY === 'merkez' || personGY === 'mersin' || personGY === 'mersinkm';
                    return personGY.includes(unitMatch);
                });

                let rowHtml = `<td class="unit-name">${u.name}</td>`;
                let totalCount = 0;

                titles.forEach(title => {
                    const count = unitPersonnel.filter(p => {
                        const pt = normalizeKey(p.t);
                        if (title === "Teknisyen/Tekniker") return pt.includes('teknik') || pt.includes('kontrol');
                        if (title === "Mühendis") return pt.includes('muhendis');
                        if (title === "İşlem Yapan Personel") return pt.includes('bilgisayar') || pt.includes('memur');
                        if (title === "Destek Personeli") return pt.includes('isci') || pt.includes('işçi');
                        return normalizeKey(title) === pt;
                    }).length;
                    
                    totalCount += count;
                    rowHtml += `<td class="${count > 0 ? 'font-bold text-blue-600' : 'text-slate-300'}">${count}</td>`;
                });

                rowHtml += `<td class="font-black bg-blue-50">${totalCount}</td>`;
                tbody.innerHTML += `<tr>${rowHtml}</tr>`;
            });
        }

        function showModal(id) {
            const d = directorateData.find(x => x.id === id);
            els.modalTitle.innerText = d.name;
            const isKM = d.group === 'kadastro';
            
            const normBtn = document.querySelector('[data-tab="personnel"]');
            if (isKM) normBtn.style.display = 'inline-block';
            else normBtn.style.display = 'none';

            els.persTable.innerHTML = '';
            if (isKM) {
                const sortedNorms = getHierarchicalSort([...d.personnel]);
                sortedNorms.forEach(p => {
                    const dif = p.current - p.norm;
                    els.persTable.innerHTML += `<tr class="hover:bg-slate-50"><td class="p-4 font-black text-slate-700 text-sm">${p.title}</td><td class="p-4 text-center font-bold text-slate-300 text-xs italic">${p.norm}</td><td class="p-4 text-center font-black text-slate-800 text-base">${p.current}</td><td class="p-4 text-center font-black text-base ${dif<0?'text-red-500':'text-emerald-500'}">${dif>=0?'+':''}${dif}</td></tr>`;
                });
            }
            
            let list = [];
            if(isKM) {
                list = allPersonnelMaster.map(r => ({ name: r.n, title: r.t, sicil: r.s, gy: r.gy || 'Mersin', c: r.c, tel: r.tel || '' }));
            } else {
                const unitMatch = normalizeKey(d.name.split(' ')[0]);
                list = allPersonnelMaster.filter(r => {
                    const personGY = normalizeKey(r.gy || 'Mersin');
                    if (unitMatch === 'merkez') return personGY === '' || personGY === 'merkez' || personGY === 'mersin' || personGY === 'mersinkm';
                    return personGY.includes(unitMatch);
                }).map(r => ({ name: r.n, title: r.t, sicil: r.s, gy: r.gy || 'Mersin', c: r.c, tel: r.tel || '' }));
            }

            const sortedList = getHierarchicalSort(list);
            els.persList.innerHTML = sortedList.length ? '' : '<tr><td colspan="5" class="p-10 text-center text-slate-300 font-black uppercase italic tracking-widest">Birimde Personel Bulunamadı</td></tr>';
            sortedList.forEach(p => {
                const icon = GENDER_ICONS[p.c] || '';
                els.persList.innerHTML += `<tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0"><td class="p-4 font-black text-slate-900 flex items-center text-sm">${icon}<span class="ml-1">${p.name}</span></td><td class="p-4 text-slate-500 font-bold uppercase text-[10px] tracking-tight">${p.title}</td><td class="p-4 text-center font-mono text-slate-400 text-[10px] tracking-widest">${p.sicil}</td><td class="p-4 text-slate-700 font-black text-[9px] uppercase bg-slate-50/50">${p.gy}</td><td class="p-4 text-blue-600 font-bold font-mono text-[10px]">${p.tel}</td></tr>`;
            });

            switchTab(isKM ? 'personnel' : 'personnel-list');
            els.detailModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function openCentral() {
            els.allPersTable.innerHTML = '';
            const sorted = getHierarchicalSort([...allPersonnelMaster]);
            sorted.forEach(p => {
                const icon = GENDER_ICONS[p.c];
                els.allPersTable.innerHTML += `<tr class="hover:bg-blue-50 transition-colors text-xs border-b border-slate-50"><td class="p-4 font-black flex items-center text-slate-900">${icon}<span class="ml-1">${p.n}</span></td><td class="p-4 text-center">${icon}</td><td class="p-4 text-[10px] font-black uppercase text-slate-600">${p.t}</td><td class="p-4 font-mono text-slate-400 tracking-widest">${p.s}</td><td class="p-4 text-[9px] font-black text-blue-600 uppercase italic">MERSİN KM</td><td class="p-4 text-[10px] uppercase font-bold text-slate-500">${p.gy || 'Mersin'}</td><td class="p-4 text-blue-700 font-bold font-mono">${p.tel || ''}</td></tr>`;
            });
            document.getElementById('all-personnel-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function switchTab(tid) {
            document.querySelectorAll('#modal-tabs button').forEach(b => b.classList.toggle('nav-active', b.dataset.tab === tid));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.toggle('hidden', p.id !== `${tid}-content`));
        }

        function switchCentralTab(tid) {
            document.querySelectorAll('#central-modal-tabs button').forEach(b => b.classList.toggle('nav-active', b.dataset.tab === tid));
            document.querySelectorAll('.central-tab-pane').forEach(p => p.classList.toggle('hidden', p.id !== `${tid}-content`));
            if(tid === 'central-title-distribution') populateTitleDistribution();
        }

        function updateStatus(isOk, msg) {
            if(!els.status) return;
            els.status.className = isOk ? 'status-ok' : 'status-error';
            els.status.innerHTML = `<i class="fas ${isOk ? 'fa-check-circle' : 'fa-exclamation-triangle'} mr-2"></i><span>${msg}</span>`;
            if(isOk) setTimeout(() => els.status.classList.add('status-hidden'), 4000);
        }

        function setupEventListeners() {
            els.closeModalBtn.onclick = () => { els.detailModal.classList.add('hidden'); document.body.style.overflow = 'auto'; };
            document.getElementById('close-all-personnel-modal-btn').onclick = () => { document.getElementById('all-personnel-modal').classList.add('hidden'); document.body.style.overflow = 'auto'; };
            els.modalTabs.onclick = e => { const tid = e.target.dataset.tab; if(tid) switchTab(tid); };
            document.getElementById('central-modal-tabs').onclick = e => { const tid = e.target.dataset.tab; if(tid) switchCentralTab(tid); };
            
            els.manualUpload.onchange = async (e) => {
                const files = e.target.files; if(!files.length) return;
                updateStatus(false, "YÜKLENİYOR...");
                for (let file of files) {
                    const reader = new FileReader();
                    const promise = new Promise(resolve => {
                        reader.onload = async (evt) => {
                            const wb = XLSX.read(new Uint8Array(evt.target.result), {type: 'array'});
                            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                            function gv(r, k) { return getVal(r, k); }
                            if (normalizeKey(file.name).includes('norm')) {
                                const normData = data.map(r => ({ t: gv(r, ['Unvan', 'Ünvan', 'Kadro Unvanı']), n: parseInt(gv(r, ['Norm Sayisi', 'Norm_Sayisi', 'Norm'])) || 0, v: parseInt(gv(r, ['Mevcut Sayisi', 'Mevcut_Sayisi', 'Fiili'])) || 0 }));
                                await saveToGithub(GITHUB_CONFIG.files.norm, normData);
                            } else {
                                const persData = data.map(r => ({ 
                                    n: gv(r, ['Adi Soyadi', 'Adı Soyadı', 'Name']), 
                                    t: gv(r, ['Unvani', 'Unvanı', 'Unvan']), 
                                    s: gv(r, ['Sicil', 'ID', 'No']), 
                                    gy: gv(r, ['Gorevli Oldugu Birim', 'Görev Yeri', 'Birim Adı', 'Birim']), 
                                    tel: gv(r, ['Ip Telefon', 'Telefon', 'Tel']) || '',
                                    c: String(gv(r, ['Cinsiyet', 'Gender']) || '').toUpperCase().startsWith('E') ? 'E' : 'K' 
                                }));
                                await saveToGithub(GITHUB_CONFIG.files.personnel, persData);
                            }
                            resolve();
                        };
                    });
                    reader.readAsArrayBuffer(file); await promise;
                }
                updateStatus(true, "BULUT GÜNCELLENDİ");
                setTimeout(() => location.reload(), 1000);
            };
        }

        function getVal(row, keys) {
            const nKeys = keys.map(k => normalizeKey(k));
            for (const rk in row) { if (nKeys.includes(normalizeKey(rk))) return row[rk]; }
            return undefined;
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
